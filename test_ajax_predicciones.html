<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test AJAX Predicciones</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîÆ Test AJAX - Predicciones</h1>
    <button onclick="testEndpoint()">üß™ Probar Endpoint</button>
    <div id="logs"></div>

    <script>
        function addLog(message, type = 'log') {
            const logsDiv = document.getElementById('logs');
            const logElement = document.createElement('div');
            logElement.className = `log ${type}`;
            logElement.textContent = message;
            logsDiv.appendChild(logElement);
        }

        async function testEndpoint() {
            document.getElementById('logs').innerHTML = '';
            
            addLog('üöÄ Iniciando test...');
            
            try {
                addLog('üì° Haciendo petici√≥n GET a /Converza/app/presenters/get_prediccion.php');
                
                const startTime = Date.now();
                const response = await fetch('/Converza/app/presenters/get_prediccion.php', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addLog(`‚è±Ô∏è Respuesta recibida en ${duration}ms`, 'success');
                addLog(`üìä Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                // Verificar headers
                addLog(`üìã Content-Type: ${response.headers.get('Content-Type')}`);
                
                // Intentar leer como texto primero
                const rawText = await response.text();
                addLog(`üìù Respuesta raw (${rawText.length} caracteres):`);
                
                const pre = document.createElement('pre');
                pre.textContent = rawText.substring(0, 1000) + (rawText.length > 1000 ? '...' : '');
                document.getElementById('logs').appendChild(pre);
                
                // Intentar parsear como JSON
                try {
                    const data = JSON.parse(rawText);
                    addLog('‚úÖ JSON v√°lido parseado', 'success');
                    
                    const jsonPre = document.createElement('pre');
                    jsonPre.textContent = JSON.stringify(data, null, 2);
                    document.getElementById('logs').appendChild(jsonPre);
                    
                    if (data.success) {
                        addLog(`‚úÖ Success: true`, 'success');
                        if (data.predicciones) {
                            addLog(`üìä Predicciones: ${data.predicciones.length}`, 'success');
                            data.predicciones.forEach((pred, idx) => {
                                addLog(`  ${idx + 1}. ${pred.emoji} ${pred.categoria}: ${pred.texto}`);
                            });
                        }
                    } else {
                        addLog(`‚ùå Success: false - Error: ${data.error}`, 'error');
                    }
                } catch (jsonError) {
                    addLog(`‚ùå Error parseando JSON: ${jsonError.message}`, 'error');
                    addLog('üí° Posiblemente hay HTML o texto adicional antes del JSON', 'error');
                    
                    // Buscar d√≥nde empieza el JSON
                    const jsonStart = rawText.indexOf('{');
                    if (jsonStart > 0) {
                        addLog(`‚ö†Ô∏è Se encontr√≥ contenido antes del JSON (${jsonStart} caracteres)`, 'error');
                        const before = document.createElement('pre');
                        before.textContent = 'Contenido extra:\n' + rawText.substring(0, jsonStart);
                        before.style.background = '#f8d7da';
                        document.getElementById('logs').appendChild(before);
                    }
                }
                
            } catch (error) {
                addLog(`‚ùå Error en la petici√≥n: ${error.message}`, 'error');
                addLog(`Stack: ${error.stack}`, 'error');
            }
        }
    </script>
</body>
</html>
