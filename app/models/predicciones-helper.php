<?php
/**
 * ‚ú® SISTEMA DE PREDICCIONES DIVERTIDAS
 * Genera predicciones sobre gustos e intereses de manera NO invasiva
 * Basado en patrones de comportamiento p√∫blico
 */

class PrediccionesHelper {
    private $conexion;
    
    // Predicciones divertidas por categor√≠a
    private const PREDICCIONES = [
        'musica' => [
            ['texto' => 'Probablemente eres fan de la m√∫sica cl√°sica üéª', 'palabras' => ['beethoven', 'mozart', 'orquesta', 'sinfon√≠a', 'viol√≠n']],
            ['texto' => 'Te gusta el rock y el metal üé∏', 'palabras' => ['rock', 'metal', 'guitarra', 'concierto', 'banda']],
            ['texto' => 'El reggaeton es tu favorito üéµ', 'palabras' => ['reggaeton', 'perreo', 'dembow', 'urbano', 'trap']],
            ['texto' => 'Eres amante del jazz y blues üé∑', 'palabras' => ['jazz', 'blues', 'saxof√≥n', 'improvisaci√≥n']],
            ['texto' => 'La m√∫sica pop te encanta üé§', 'palabras' => ['pop', 'cantar', 'karaoke', 'top']],
        ],
        'comida' => [
            ['texto' => 'Eres un foodie apasionado üçï', 'palabras' => ['comida', 'comer', 'delicioso', 'rico', 'hambre', 'pizza', 'hamburguesa']],
            ['texto' => 'El caf√© es tu combustible ‚òï', 'palabras' => ['caf√©', 'cappuccino', 'latte', 'espresso', 'cafe√≠na']],
            ['texto' => 'Los postres son tu debilidad üç∞', 'palabras' => ['postre', 'dulce', 'chocolate', 'pastel', 'helado']],
            ['texto' => 'Eres fan de la comida saludable ü•ó', 'palabras' => ['saludable', 'fitness', 'dieta', 'vegetariano', 'vegano', 'ensalada']],
            ['texto' => 'La comida r√°pida te llama üçî', 'palabras' => ['mcdonald', 'burger', 'kfc', 'r√°pida', 'delivery']],
        ],
        'hobbies' => [
            ['texto' => 'Los videojuegos son tu pasi√≥n üéÆ', 'palabras' => ['juego', 'gaming', 'gamer', 'ps5', 'xbox', 'nintendo', 'videojuego']],
            ['texto' => 'Eres un apasionado de la lectura üìö', 'palabras' => ['libro', 'leer', 'lectura', 'novela', 'autor', 'biblioteca']],
            ['texto' => 'El arte y la creatividad te inspiran üé®', 'palabras' => ['arte', 'pintura', 'dibujo', 'creatividad', 'dise√±o']],
            ['texto' => 'El deporte es tu vida üèãÔ∏è', 'palabras' => ['deporte', 'gym', 'ejercicio', 'fitness', 'entrenar', 'correr']],
            ['texto' => 'Amas la fotograf√≠a üì∑', 'palabras' => ['foto', 'fotograf√≠a', 'c√°mara', 'imagen', 'capturar']],
        ],
        'viajes' => [
            ['texto' => 'Tienes alma de aventurero üåç', 'palabras' => ['viajar', 'viaje', 'aventura', 'explorar', 'turismo', 'destino']],
            ['texto' => 'La playa es tu lugar favorito üèñÔ∏è', 'palabras' => ['playa', 'mar', 'arena', 'sol', 'vacaciones']],
            ['texto' => 'Prefieres la monta√±a üèîÔ∏è', 'palabras' => ['monta√±a', 'hiking', 'senderismo', 'naturaleza', 'bosque']],
            ['texto' => 'Las ciudades grandes te fascinan üåÜ', 'palabras' => ['ciudad', 'urbano', 'rascacielos', 'metr√≥polis']],
        ],
        'personalidad' => [
            ['texto' => 'Eres una persona muy sociable üòä', 'palabras' => ['amigos', 'fiesta', 'salir', 'gente', 'social']],
            ['texto' => 'Tienes un gran sentido del humor üòÇ', 'palabras' => ['jaja', 'lol', 'gracioso', 'risa', 'divertido', 'chistoso']],
            ['texto' => 'Eres reflexivo y filos√≥fico ü§î', 'palabras' => ['pensar', 'reflexi√≥n', 'filosof√≠a', 'vida', 'sentido']],
            ['texto' => 'La tecnolog√≠a te apasiona üíª', 'palabras' => ['tecnolog√≠a', 'computadora', 'internet', 'app', 'software']],
            ['texto' => 'Eres amante de los animales üê∂', 'palabras' => ['perro', 'gato', 'mascota', 'animal', 'pet']],
        ],
    ];
    
    public function __construct($conexion) {
        $this->conexion = $conexion;
    }
    
    /**
     * Genera una nueva predicci√≥n para el usuario
     */
    public function generarPrediccion($usuario_id) {
        try {
            // 1. Analizar publicaciones y comentarios del usuario
            $stmt = $this->conexion->prepare("
                SELECT p.contenido as texto FROM publicaciones p WHERE p.usuario = ? 
                UNION ALL
                SELECT c.comentario as texto FROM comentarios c WHERE c.usuario = ?
                ORDER BY RAND()
                LIMIT 50
            ");
            $stmt->execute([$usuario_id, $usuario_id]);
            $textos = $stmt->fetchAll(PDO::FETCH_COLUMN);
            
            if (empty($textos)) {
                // Usuario nuevo sin actividad ‚Üí predicci√≥n gen√©rica para cada categor√≠a
                return $this->generarPrediccionesGenericas($usuario_id);
            }
            
            // 2. Unir todos los textos
            $textoCompleto = mb_strtolower(implode(' ', $textos));
            
            // 3. Generar UNA predicci√≥n por cada categor√≠a
            $prediccionesGeneradas = [];
            
            foreach (self::PREDICCIONES as $categoria => $predicciones) {
                $mejorPrediccion = null;
                $mejorPuntuacion = 0;
                
                foreach ($predicciones as $prediccion) {
                    $puntuacion = 0;
                    
                    // Contar palabras clave encontradas
                    foreach ($prediccion['palabras'] as $palabra) {
                        $puntuacion += substr_count($textoCompleto, $palabra);
                    }
                    
                    if ($puntuacion > $mejorPuntuacion) {
                        $mejorPuntuacion = $puntuacion;
                        $mejorPrediccion = [
                            'categoria' => $categoria,
                            'texto' => $prediccion['texto'],
                            'confianza' => $this->calcularConfianza($puntuacion)
                        ];
                    }
                }
                
                // Si no se encontr√≥ nada, usar predicci√≥n aleatoria de la categor√≠a
                if (!$mejorPrediccion || $mejorPuntuacion === 0) {
                    $prediccionAleatoria = $predicciones[array_rand($predicciones)];
                    $mejorPrediccion = [
                        'categoria' => $categoria,
                        'texto' => $prediccionAleatoria['texto'],
                        'confianza' => 'baja'
                    ];
                }
                
                // Guardar predicci√≥n en BD
                $this->guardarPrediccion($usuario_id, $mejorPrediccion);
                $prediccionesGeneradas[] = $mejorPrediccion;
            }
            
            return $prediccionesGeneradas;
            
        } catch (Exception $e) {
            error_log("Error generando predicci√≥n: " . $e->getMessage());
            return $this->generarPrediccionesGenericas($usuario_id);
        }
    }
    
    /**
     * Generar predicciones gen√©ricas (una por categor√≠a)
     */
    private function generarPrediccionesGenericas($usuario_id) {
        $prediccionesGenericas = [];
        
        foreach (self::PREDICCIONES as $categoria => $predicciones) {
            $prediccionAleatoria = $predicciones[array_rand($predicciones)];
            $prediccion = [
                'categoria' => $categoria,
                'texto' => $prediccionAleatoria['texto'],
                'confianza' => 'baja'
            ];
            
            $this->guardarPrediccion($usuario_id, $prediccion);
            $prediccionesGenericas[] = $prediccion;
        }
        
        return $prediccionesGenericas;
    }
    
    /**
     * Obtener predicciones no vistas del usuario
     */
    public function obtenerPredicciones($usuario_id) {
        // Obtener todas las predicciones no vistas
        $stmt = $this->conexion->prepare("
            SELECT * FROM predicciones_usuarios 
            WHERE usuario_id = ? AND visto = 0 
            ORDER BY FIELD(categoria, 'musica', 'comida', 'hobbies', 'viajes', 'personalidad'), fecha_generada DESC
        ");
        $stmt->execute([$usuario_id]);
        $predicciones = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if (empty($predicciones)) {
            // No hay predicciones ‚Üí generar nuevas (5 en total, una por categor√≠a)
            $nuevasPredicciones = $this->generarPrediccion($usuario_id);
            
            // Convertir a formato de BD
            $stmt = $this->conexion->prepare("
                SELECT * FROM predicciones_usuarios 
                WHERE usuario_id = ? AND visto = 0 
                ORDER BY FIELD(categoria, 'musica', 'comida', 'hobbies', 'viajes', 'personalidad'), fecha_generada DESC
            ");
            $stmt->execute([$usuario_id]);
            $predicciones = $stmt->fetchAll(PDO::FETCH_ASSOC);
        }
        
        return $predicciones;
    }
    
    /**
     * Obtener estad√≠sticas de predicciones
     */
    public function obtenerEstadisticas($usuario_id) {
        $stmt = $this->conexion->prepare("
            SELECT 
                COUNT(*) as total,
                SUM(CASE WHEN visto = 0 THEN 1 ELSE 0 END) as pendientes,
                SUM(CASE WHEN visto = 1 THEN 1 ELSE 0 END) as vistas
            FROM predicciones_usuarios 
            WHERE usuario_id = ?
        ");
        $stmt->execute([$usuario_id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }
    
    /**
     * Marcar predicci√≥n como vista
     */
    public function marcarVista($prediccion_id) {
        $stmt = $this->conexion->prepare("UPDATE predicciones_usuarios SET visto = 1 WHERE id = ?");
        return $stmt->execute([$prediccion_id]);
    }
    
    /**
     * Guardar valoraci√≥n (me gusta / no me gusta)
     */
    public function valorarPrediccion($prediccion_id, $me_gusta) {
        $stmt = $this->conexion->prepare("UPDATE predicciones_usuarios SET me_gusta = ?, visto = 1 WHERE id = ?");
        return $stmt->execute([$me_gusta, $prediccion_id]);
    }
    
    /**
     * Calcular confianza seg√∫n puntuaci√≥n
     */
    private function calcularConfianza($puntuacion) {
        if ($puntuacion >= 5) return 'alta';
        if ($puntuacion >= 2) return 'media';
        return 'baja';
    }
    
    /**
     * Guardar predicci√≥n en BD
     */
    private function guardarPrediccion($usuario_id, $prediccion) {
        $emoji = $this->obtenerEmoji($prediccion['categoria']);
        
        $stmt = $this->conexion->prepare("
            INSERT INTO predicciones_usuarios (usuario_id, categoria, prediccion, emoji, confianza)
            VALUES (?, ?, ?, ?, ?)
        ");
        
        return $stmt->execute([
            $usuario_id,
            $prediccion['categoria'],
            $prediccion['texto'],
            $emoji,
            $prediccion['confianza']
        ]);
    }
    
    /**
     * Obtener emoji representativo
     */
    private function obtenerEmoji($categoria) {
        $emojis = [
            'musica' => 'üéµ',
            'comida' => 'üçΩÔ∏è',
            'hobbies' => 'üéØ',
            'viajes' => '‚úàÔ∏è',
            'personalidad' => '‚ú®'
        ];
        return $emojis[$categoria] ?? 'üîÆ';
    }
    
    /**
     * Predicci√≥n gen√©rica para usuarios nuevos
     */
    private function prediccionGenerica() {
        return [
            'categoria' => 'personalidad',
            'texto' => 'Tienes un gran potencial por descubrir ‚ú®',
            'confianza' => 'media',
            'emoji' => 'üîÆ'
        ];
    }
    
    /**
     * Predicci√≥n aleatoria si no se detecta nada
     */
    private function prediccionAleatoria() {
        $categorias = array_keys(self::PREDICCIONES);
        $categoriaAleatoria = $categorias[array_rand($categorias)];
        $prediccionesCategoria = self::PREDICCIONES[$categoriaAleatoria];
        $prediccionAleatoria = $prediccionesCategoria[array_rand($prediccionesCategoria)];
        
        return [
            'categoria' => $categoriaAleatoria,
            'texto' => $prediccionAleatoria['texto'],
            'confianza' => 'baja',
            'emoji' => $this->obtenerEmoji($categoriaAleatoria)
        ];
    }
}
?>
